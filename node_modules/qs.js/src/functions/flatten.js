import {createStreamConstructor} from './common';
import isArray from '../polyfill/isArray';
import {forEach} from '../polyfill/list';

const mixin = {
    init({fn}) {
        this._fn = fn;
    },

    _free() {
        this._fn = null;
    },

    _handleValue(arr) {
        const x = this._fn(arr);
        if (isArray (x)) {
            forEach(x, (v) => this.emitValue(v));
        } else {
            this.emitValue(x);
        }
    }
};

const S = createStreamConstructor('flatten', mixin);

const id = x => x;
function flatten(source, fn = id) {
    return new S(source, {fn});
}



export default flatten;